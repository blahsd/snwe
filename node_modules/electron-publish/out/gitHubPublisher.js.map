{"version":3,"file":"gitHubPublisher.js","sourceRoot":"","sources":["../src/gitHubPublisher.ts"],"names":[],"mappings":"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","sourcesContent":["import { Arch, InvalidConfigurationError, isEmptyOrSpaces, isEnvTrue, isTokenCharValid, log } from \"builder-util\"\nimport { configureRequestOptions, GithubOptions, HttpError, parseJson } from \"builder-util-runtime\"\nimport { Fields } from \"builder-util/out/log\"\nimport { httpExecutor } from \"builder-util/out/nodeHttpExecutor\"\nimport { ClientRequest } from \"http\"\nimport { Lazy } from \"lazy-val\"\nimport mime from \"mime\"\nimport { parse as parseUrl } from \"url\"\nimport { getCiTag, HttpPublisher, PublishContext, PublishOptions } from \"./publisher\"\n\nexport interface Release {\n  id: number\n  tag_name: string\n\n  draft: boolean\n  prerelease: boolean\n\n  published_at: string\n\n  upload_url: string\n}\n\ninterface Asset {\n  id: number\n  name: string\n}\n\nexport class GitHubPublisher extends HttpPublisher {\n  private readonly tag: string\n  readonly _release = new Lazy(() => this.token === \"__test__\" ? Promise.resolve(null as any) : this.getOrCreateRelease())\n\n  private readonly token: string\n\n  readonly providerName = \"GitHub\"\n\n  private readonly releaseType: \"draft\" | \"prerelease\" | \"release\"\n\n  private releaseLogFields: Fields | null = null\n\n  constructor(context: PublishContext, private readonly info: GithubOptions, private readonly version: string, private readonly options: PublishOptions = {}) {\n    super(context, true)\n\n    let token = info.token\n    if (isEmptyOrSpaces(token)) {\n      token = process.env.GH_TOKEN || process.env.GITHUB_TOKEN\n      if (isEmptyOrSpaces(token)) {\n        throw new InvalidConfigurationError(`GitHub Personal Access Token is not set, neither programmatically, nor using env \"GH_TOKEN\"`)\n      }\n\n      token = token.trim()\n\n      if (!isTokenCharValid(token)) {\n        throw new InvalidConfigurationError(`GitHub Personal Access Token (${JSON.stringify(token)}) contains invalid characters, please check env \"GH_TOKEN\"`)\n      }\n    }\n\n    this.token = token!\n\n    if (version.startsWith(\"v\")) {\n      throw new InvalidConfigurationError(`Version must not starts with \"v\": ${version}`)\n    }\n\n    this.tag = info.vPrefixedTagName === false ? version : `v${version}`\n\n    if (isEnvTrue(process.env.EP_DRAFT)) {\n      this.releaseType = \"draft\"\n      log.info({reason: \"env EP_DRAFT is set to true\"}, \"GitHub provider release type is set to draft\")\n    }\n    else if (isEnvTrue(process.env.EP_PRE_RELEASE) || isEnvTrue(process.env.EP_PRELEASE) /* https://github.com/electron-userland/electron-builder/issues/2878 */) {\n      this.releaseType = \"prerelease\"\n      log.info({reason: \"env EP_PRE_RELEASE is set to true\"}, \"GitHub provider release type is set to prerelease\")\n    }\n    else if (info.releaseType != null) {\n      this.releaseType = info.releaseType\n    }\n    else if ((options as any).prerelease) {\n      this.releaseType = \"prerelease\"\n    }\n    else {\n      this.releaseType = (options as any).draft === false ? \"release\" : \"draft\"\n    }\n  }\n\n  private async getOrCreateRelease(): Promise<Release | null> {\n    const logFields = {\n      tag: this.tag,\n      version: this.version,\n    }\n\n    // we don't use \"Get a release by tag name\" because \"tag name\" means existing git tag, but we draft release and don't create git tag\n    const releases = await this.githubRequest<Array<Release>>(`/repos/${this.info.owner}/${this.info.repo}/releases`, this.token)\n    for (const release of releases) {\n      if (!(release.tag_name === this.tag || release.tag_name === this.version)) {\n        continue\n      }\n\n      if (release.draft) {\n        return release\n      }\n\n      // https://github.com/electron-userland/electron-builder/issues/1197\n      // https://electron-builder.slack.com/archives/general/p1485961449000202\n      // https://github.com/electron-userland/electron-builder/issues/2072\n      if (this.releaseType === \"draft\") {\n        this.releaseLogFields = {\n          reason: \"existing type not compatible with publishing type\",\n          ...logFields,\n          existingType: release.prerelease ? \"pre-release\" : \"release\",\n          publishingType: this.releaseType,\n        }\n        log.warn(this.releaseLogFields, \"GitHub release not created\")\n        return null\n      }\n\n      // https://github.com/electron-userland/electron-builder/issues/1133\n      // https://github.com/electron-userland/electron-builder/issues/2074\n      // if release created < 2 hours â€” allow to upload\n      const publishedAt = release.published_at == null ? null : Date.parse(release.published_at)\n      if (publishedAt != null && (Date.now() - publishedAt) > (2 * 3600 * 1000)) {\n        // https://github.com/electron-userland/electron-builder/issues/1183#issuecomment-275867187\n        this.releaseLogFields = {\n          reason: \"existing release published more than 2 hours ago\",\n          ...logFields,\n          date: new Date(publishedAt).toString(),\n        }\n        log.warn(this.releaseLogFields, \"GitHub release not created\")\n        return null\n      }\n      return release\n    }\n\n    // https://github.com/electron-userland/electron-builder/issues/1835\n    if (this.options.publish === \"always\" || getCiTag() != null) {\n      log.info({\n        reason: \"release doesn't exist\",\n        ...logFields,\n      }, `creating GitHub release`)\n      return this.createRelease()\n    }\n\n    this.releaseLogFields = {\n      reason: \"release doesn't exist and not created because \\\"publish\\\" is not \\\"always\\\" and build is not on tag\",\n      ...logFields,\n    }\n    return null\n  }\n\n  private async overwriteArtifact(fileName: string, release: Release) {\n    // delete old artifact and re-upload\n    log.notice({file: fileName, reason: \"already exists on GitHub\"}, \"overwrite published file\")\n\n    const assets = await this.githubRequest<Array<Asset>>(`/repos/${this.info.owner}/${this.info.repo}/releases/${release.id}/assets`, this.token, null)\n    for (const asset of assets) {\n      if (asset!.name === fileName) {\n        await this.githubRequest<void>(`/repos/${this.info.owner}/${this.info.repo}/releases/assets/${asset!.id}`, this.token, null, \"DELETE\")\n        return\n      }\n    }\n\n    log.debug({file: fileName, reason: \"not found on GitHub\"}, \"trying to upload again\")\n  }\n\n  protected async doUpload(fileName: string, arch: Arch, dataLength: number, requestProcessor: (request: ClientRequest, reject: (error: Error) => void) => void): Promise<any> {\n    const release = await this._release.value\n    if (release == null) {\n      log.warn({file: fileName, ...this.releaseLogFields}, \"skipped publishing\")\n      return\n    }\n\n    const parsedUrl = parseUrl(release.upload_url.substring(0, release.upload_url.indexOf(\"{\")) + \"?name=\" + fileName)\n    let attemptNumber = 0\n    for (let i = 0; i < 3; i++) {\n      try {\n        return await httpExecutor.doApiRequest(configureRequestOptions({\n          hostname: parsedUrl.hostname,\n          path: parsedUrl.path,\n          method: \"POST\",\n          headers: {\n            Accept: \"application/vnd.github.v3+json\",\n            \"Content-Type\": mime.getType(fileName) || \"application/octet-stream\",\n            \"Content-Length\": dataLength\n          }\n        }, this.token), this.context.cancellationToken, requestProcessor)\n      }\n      catch (e) {\n        if (e instanceof HttpError && e.statusCode === 422 && e.description != null && e.description.errors != null && e.description.errors[0].code === \"already_exists\") {\n          await this.overwriteArtifact(fileName, release)\n          continue\n        }\n\n        if (!(attemptNumber++ < 3 && (e instanceof HttpError || (e.code === \"EPIPE\" || e.code === \"ECONNRESET\")))) {\n          throw e\n        }\n      }\n    }\n  }\n\n  private createRelease() {\n    return this.githubRequest<Release>(`/repos/${this.info.owner}/${this.info.repo}/releases`, this.token, {\n      tag_name: this.tag,\n      name: this.version,\n      draft: this.releaseType === \"draft\",\n      prerelease: this.releaseType === \"prerelease\",\n    })\n  }\n\n  // test only\n  //noinspection JSUnusedGlobalSymbols\n  async getRelease(): Promise<any> {\n    return this.githubRequest<Release>(`/repos/${this.info.owner}/${this.info.repo}/releases/${(await this._release.value)!.id}`, this.token)\n  }\n\n  //noinspection JSUnusedGlobalSymbols\n  async deleteRelease(): Promise<any> {\n    if (!this._release.hasValue) {\n      return\n    }\n\n    const release = await this._release.value\n    for (let i = 0; i < 3; i++) {\n      try {\n        return await this.githubRequest(`/repos/${this.info.owner}/${this.info.repo}/releases/${release.id}`, this.token, null, \"DELETE\")\n      }\n      catch (e) {\n        if (e instanceof HttpError) {\n          if (e.statusCode === 404) {\n            log.warn({releaseId: release.id, reason: \"doesn't exist\"}, \"cannot delete release\")\n            return\n          }\n          else if (e.statusCode === 405 || e.statusCode === 502) {\n            continue\n          }\n        }\n\n        throw e\n      }\n    }\n\n    log.warn({releaseId: release.id}, \"cannot delete release\")\n  }\n\n  private githubRequest<T>(path: string, token: string | null, data: {[name: string]: any; } | null = null, method?: \"GET\" | \"DELETE\" | \"PUT\"): Promise<T> {\n    // host can contains port, but node http doesn't support host as url does\n    const baseUrl = parseUrl(`https://${this.info.host || \"api.github.com\"}`)\n    return parseJson(httpExecutor.request(configureRequestOptions({\n      hostname: baseUrl.hostname,\n      port: baseUrl.port as any,\n      path: (this.info.host != null && this.info.host !== \"github.com\") ? `/api/v3${path.startsWith(\"/\") ? path : `/${path}`}` : path,\n      headers: {Accept: \"application/vnd.github.v3+json\"}\n    }, token, method), this.context.cancellationToken, data))\n  }\n\n  toString() {\n    return `Github (owner: ${this.info.owner}, project: ${this.info.repo}, version: ${this.version})`\n  }\n}\n"]}
